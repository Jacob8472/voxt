Carve a clean-cut ‚Äúinstallation story‚Äù out of the current tangle and sketch how testing and packaging will bolt onto it.
Each objective is treated as a mini-plan one can actually execute (and iterate on) rather than a hand-wavy wish-list.

---

## 1 ‚É£ Refactor the install / setup path

*(Git-clone ‚Üí `./setup.sh` ‚Üí happy user)*

| Step                                                        | What we keep / drop                                                                                                                                                                                                              | Rationale & concrete TODOs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ----------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **A. Single entry-point script**<br>`setup.sh` at repo root | *Keep*, but **simplify**. It presently: <br>‚Ä¢ yells if run as root ‚úÖ<br>‚Ä¢ builds venv ‚úÖ<br>‚Ä¢ installs apt deps ‚úÖ but too chatty<br>‚Ä¢ clones + builds whisper.cpp ‚úÖ<br>‚Ä¢ does ydotool dance (duplicated in `setup_ydotool.sh`) üîÑ | *Trim & modularise*: <br>1. **Phase 0 ‚Äì self-diagnose** (no sudo)<br>¬†¬†\* python ‚â•3.9?<br>¬†¬†\* gcc/cmake present?<br>¬†¬†\* XDG\_SESSION\_TYPE? (warn if unknown)<br>2. **Phase 1 ‚Äì ask for sudo once**, then install missing packages.<br>3. **Phase 2 ‚Äì venv + `pip install -r requirements.txt`** (use `python -m venv .venv && . .venv/bin/activate` quietly).<br>4. **Phase 3 ‚Äì build whisper.cpp** <br>¬†¬†‚Ä¢ detect CPU arch; allow `--cuda` flag to pass to CMake.<br>5. **Phase 4 ‚Äì backend helpers** <br>¬†¬†‚Ä¢ if Wayland && !ydotool: offer to run dedicated helper (`setup_ydotool.sh`).<br>6. **Phase 5 ‚Äì config/hotkey wizard** (minimal <span style="font-size:0.9em;">‚Üí</span> ask once, write to XDG config). |
| **B. `setup_ydotool.sh`**                                   | *Keep* but **gate-call** it. Only executed from the main script if Wayland & user said ‚Äúyes‚Äù.                                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **C. `setup_utils.py`**                                     | *Keep* as **diagnostics-only** tool (`python -m whisp.utils.setup_utils --check`).  Remove install/apt logic (now lives in bash).                                                                                                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **D. UI after install**                                     | When the shell script ends: <br>`bash<br>source .venv/bin/activate && python -m whisp --mode gui<br>`<br>printed in green, so the user tries it immediately.                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **E. Documentation**                                        | `README.md` ‚Üí replace clone block with two commands:<br>`bash<br>git clone ‚Ä¶ && cd whisp<br>./setup.sh   # ~5-10 min first time<br>`                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

### Directory tweaks

* Move **everything Python** into a `src/whisp/` tree (you already did, good).
* Scripts (`setup.sh`, `setup_ydotool.sh`) stay in repo root for discoverability.
* Keep whisper.cpp as a git submodule?  Your call ‚Äì but **do not** clone it in setup if it‚Äôs already there.

---

## 2 ‚É£ Testing strategy

### 2.1 Manual smoke tests

| Test ID   | What a human does                                         | Expected                                       |
| --------- | --------------------------------------------------------- | ---------------------------------------------- |
| T-GUI-01  | `source .venv/bin/activate && python -m whisp --mode gui` | GUI pops, record ‚Üí transcript typed into gedit |
| T-TRAY-02 | `python -m whisp --mode whisp`, then hotkey               | Status flips to Recording ‚Üí Transcript typed   |
| T-CLI-03  | `python -m whisp --mode cli`, press `r`                   | Same as above, transcript printed              |

Document these in `development/test_checklist.md` (exists ‚Äì good).

### 2.2 Automated tests (pytest)

* **Unit**

  * `tests/test_paths.py` ‚Äì mock env, assert `find_whisper_cli()` precedence.
  * `tests/test_config.py` ‚Äì load, set, save round-trip.
  * `tests/test_recorder_dummy.py` ‚Äì patch `sounddevice.InputStream` with dummy generator ‚Üí ensures `.wav` written.

* **Integration** (marked *slow*)

  * Spin up `pytest` with `.venv/bin/whisper-cli` mocked to `echo` a fake transcript file ‚Äì run `core_runner.run_core_process()` in `--simulate-type=False` mode, assert clipboard called.

### 2.3 Hardware-dependent e2e

*Tag as ‚Äúe2e‚Äù ‚Äì only runs in your local VM farm, not CI.*

* On Ubuntu-Wayland VM, run setup script non-interactively (`yes "" | ./setup.sh`), assert exit 0.
* On Fedora-X11 VM, run same.

(We‚Äôll wire Vagrant or Ansible later.)

---

## 3 ‚É£ Cross-distro test matrix via local VMs

Your single host + `virt-manager` is fine. Tips:

| Distro VM              | Base box suggestion                           | Gotchas                                                                       |
| ---------------------- | --------------------------------------------- | ----------------------------------------------------------------------------- |
| Ubuntu 24.04 (Wayland) | Download cloud-img, enable `qemu-guest-agent` | Must `loginctl enable-linger $USER` for user systemd so ydotoold auto-starts. |
| Fedora 40 (Wayland)    | Official qcow2                                | SELinux may block `/dev/uinput`; add a rule or set permissive just for test.  |
| Pop!\_OS 22.04 (X11)   | ISO                                           | Ships GNOME X.Org by default ‚Äì good xdotool test.                             |

Write **snapshot scripts** (`scripts/ci/vm_run.sh`) that:

1. `scp` your repo into `/home/vmuser/whisp`,
2. `ssh` run `./setup.sh --assume-yes`,
3. run `python -m whisp --mode hear --diagnose` and capture output.

Automate with `ansible-playbook` or plain Bash loops.

---

## 4 ‚É£ CI/CD into AppImage (viability check)

| Question                                    | Answer                                                                                                                                                                                                                                                       |                                                                                                                                                                                                         |
| ------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Build Whisper C binary inside AppImage?** | Yes.  AppImage runs on the builder‚Äôs glibc, so compile on **Ubuntu 20.04** to maximise compatibility.                                                                                                                                                        |                                                                                                                                                                                                         |
| **Bundle Python + venv inside?**            | Use `linuxdeploy + linuxdeploy-plugin-python` ‚Äì it sweeps a virtualenv into `/usr/`.                                                                                                                                                                         |                                                                                                                                                                                                         |
| **Size**                                    | AppImage with **base.en model** ‚âà 160 MB.  Acceptable; `Olive Video Editor` etc. ship >200 MB.                                                                                                                                                               |                                                                                                                                                                                                         |
| **Cross-arch**                              | x86-64 only out-of-the-box.  For ARM (Raspberry Pi / Apple), you‚Äôd need separate builders or try OCI image.                                                                                                                                                  |                                                                                                                                                                                                         |
| **GitHub Actions recipe**                   | \`\`\`yaml<br>jobs:<br>  appimage:<br>    runs-on: ubuntu-20.04<br>    steps:<br>      - uses: actions/checkout\@v4<br>      - name: Build whisper.cpp<br>        run: cmake -B build && cmake --build build -j<br>      - name: linuxdeploy<br>        run: | <br>          pip install . --target appdir/usr/lib/pythonX.Y/site-packages<br>          linuxdeploy --appdir appdir -i whisp/assets/icon.png -e .venv/bin/python -d AppRun --output appimage<br>\`\`\` |
| **Auto-update**                             | Later: embed `gh-releases-zsync` for delta updates.                                                                                                                                                                                                          |                                                                                                                                                                                                         |

So: *yes*, AppImage is straightforward once the in-repo install path is tidy; consider it ‚ÄúPhase-2‚Äù.

---

## 5 ‚É£ Immediate task list (actionable PR sequence)

1. **`install/` branch**

   * Rewrite `setup.sh` per plan (phased, modular, no redundant ydotool code).
   * Move whisper.cpp clone/build logic behind `if [ ! -d whisper.cpp ]` guard.
   * Kill unused/duplicated bits (`setup_utils.py` apt install loops).

2. **`tests/` branch**

   * Add pytest + minimal unit tests skeleton.
   * CI GitHub Action running `pytest -q` on ubuntu-latest.

3. **`vm-scripts/` branch**

   * Bash script that provisions Ubuntu / Fedora with cloud-init and runs install ‚Äì produces artefact logs.

4. **`appimage-poc/` branch** (optional, after #1)

   * Minimal GitHub Action that spits a `whisp-x86_64.AppImage` on every push.

Push each, we review, merge, iterate.

---
