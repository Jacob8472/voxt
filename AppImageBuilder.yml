# AppImageBuilder.yml
# Thin AppImage for VOXD â€“ bundles Python app and its deps, fetches heavy engines at runtime.
version: 1
AppDir:
  path: AppDir
  app_info:
    id: voxd
    name: VOXD
    icon: voxd
    version: ${APP_VERSION}
    exec: usr/bin/voxd
    exec_args: --gui
  apt:
    arch: amd64
    sources:
      - sourceline: deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy main universe
    include:
      - python3-pip
      - python3
      - python3-venv
      - python3-distutils
      - libglib2.0-0
      - libxkbcommon-x11-0
      - libxcb-cursor0
      - libxcb-xinerama0
      - libxcb-util1
      - libopengl0
      - libgl1
      - libasound2
      - libportaudio2
  files:
    include:
      - src
      - pyproject.toml
      - README.md
      - LICENSE
      - launcher_setup.sh
    exclude:
      - whisper.cpp
      - llama.cpp
      - venv
      - .venv
      - build
      - dist
  runtime:
    env:
      QT_PLUGIN_PATH: "$APPDIR/usr/plugins"
      QML2_IMPORT_PATH: "$APPDIR/usr/qml"
      LD_LIBRARY_PATH: "$APPDIR/usr/lib:$APPDIR/lib:$LD_LIBRARY_PATH"
script:
  - |
    set -e
    python3 -m venv AppDir/usr/venv
    AppDir/usr/venv/bin/pip install --no-cache-dir --no-compile .
    install -d AppDir/usr/bin
    cat > AppDir/usr/bin/voxd <<'EOF'
    #!/bin/sh
    HERE="$(CDPATH= cd -- "$(dirname -- "$0")" && pwd -P)/.."
    exec "$HERE/venv/bin/python" -m voxd "$@"
    EOF
    chmod +x AppDir/usr/bin/voxd
  - install -Dm644 src/voxd/assets/voxd-5.png AppDir/usr/share/icons/hicolor/256x256/apps/voxd.png
  - |
    cat > AppDir/voxd.desktop <<EOF
    [Desktop Entry]
    Type=Application
    Name=VOXD
    Exec=usr/bin/voxd --gui
    Icon=voxd
    Categories=Utility;Audio;Qt;
    EOF
AppImage:
  arch: x86_64
  update-information: guess
